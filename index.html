<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Acompanhamento dos Estudantes</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- PapaParse para ler o CSV -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <!-- SheetJS para gerar XLSX -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    :root {
      --verde-escuro: #216c3a;
      --verde-medio: #3b9150;
      --verde-claro: #e5f5ea;
      --fundo: #e9f3ff;
      --erro: #ffe5e5;
    }

    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
    }

    body {
      margin: 0;
      padding: 0;
      background: radial-gradient(circle at top left, #e9f3ff, #dff2e7);
    }

    .page {
      max-width: 1100px;
      margin: 30px auto;
      padding: 24px;
      background: #ffffff;
      border-radius: 24px;
      box-shadow: 0 18px 40px rgba(0, 0, 0, 0.08);
    }

    h1 {
      margin: 0 0 4px;
      color: var(--verde-escuro);
    }

    .subtitle {
      color: #555;
      margin-bottom: 20px;
      font-size: 0.95rem;
    }

    .filters {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 10px;
      margin-bottom: 16px;
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 0.85rem;
    }

    .field label {
      font-weight: 600;
      color: #333;
    }

    .field input,
    .field select {
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid #ccc;
      font-size: 0.9rem;
      outline: none;
      transition: border-color 0.15s, box-shadow 0.15s;
      background-color: #f9fafb;
    }
    /* Campo nome com o MESMO tom de vermelho das linhas com erro */
    #nomeResponsavel.campo-erro {
      background-color: var(--erro) !important;     /* mesmo fundo das linhas */
      border-color: #b71c1c !important;             /* borda mais escura */
      box-shadow: 0 0 0 2px rgba(183, 28, 28, 0.25);
    }
    .field input:focus,
    .field select:focus {
      border-color: var(--verde-medio);
      box-shadow: 0 0 0 2px rgba(59, 145, 80, 0.25);
      background: #ffffff;
    }

    .field input::placeholder {
      color: #aaa;
    }

    .table-wrapper {
      margin-top: 10px;
      border-radius: 18px;
      overflow: auto;
      border: 1px solid #d7e3da;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
      min-width: 900px;
    }

    thead {
      background: var(--verde-escuro);
      color: white;
    }

    thead th {
      padding: 6px 6px;
      text-align: left;
      font-weight: 600;
      border-bottom: 1px solid #17502a;
      white-space: nowrap;
      font-size: 0.8rem;
      vertical-align: middle;
    }

    thead th small {
      font-size: 0.7rem;
      font-weight: 400;
      opacity: 0.9;
    }

    tbody td {
      padding: 6px 6px;
      border-bottom: 1px solid #edf2f0;
      font-size: 0.8rem;
    }

    tbody tr:nth-child(odd) {
      background: #ffffff;
    }

    tbody tr:nth-child(even) {
      background: var(--verde-claro);
    }

    tbody tr.erro-validacao {
      background: var(--erro) !important;
    }

    tbody select,
    tbody input[type="text"] {
      width: 100%;
      font-size: 0.8rem;
      padding: 4px 6px;
      border-radius: 999px;
      border: 1px solid #ccc;
      background: #ffffff;
      outline: none;
    }

    tbody input[type="text"] {
      border-radius: 12px;
    }

    /* Larguras especÃ­ficas das colunas novas */
    th.col-resultado,
    td.col-resultado {
      width: 120px;
    }

    th.col-acompanhado,
    td.col-acompanhado {
      width: 130px;
    }

    th.col-acoes,
    td.col-acoes {
      width: 180px;
    }

    th.col-obs,
    td.col-obs {
      width: 220px;
    }

    .actions-bar {
      margin-top: 14px;
      display: flex;
      align-items: center;
      gap: 16px;
      flex-wrap: wrap;
    }

    .btn-primary {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 18px;
      border-radius: 999px;
      border: none;
      background: var(--verde-escuro);
      color: white;
      font-weight: 600;
      font-size: 0.95rem;
      cursor: pointer;
      box-shadow: 0 10px 24px rgba(33, 108, 58, 0.35);
      transition: transform 0.1s, box-shadow 0.1s, background 0.15s;
    }

    .btn-primary:hover {
      background: var(--verde-medio);
      transform: translateY(-1px);
      box-shadow: 0 14px 30px rgba(33, 108, 58, 0.4);
    }

    .btn-primary:active {
      transform: translateY(0);
      box-shadow: 0 8px 18px rgba(0, 0, 0, 0.25);
    }

    .btn-primary span.icon {
      font-size: 1.1rem;
    }

    .status {
      font-size: 0.85rem;
    }

    .status.ok {
      color: var(--verde-medio);
      font-weight: 600;
    }

    .status.error {
      color: #c62828;
      font-weight: 600;
    }

    .status.muted {
      color: #666;
    }

    @media (max-width: 800px) {
      .page {
        margin: 8px;
        padding: 14px;
      }
      .filters {
        grid-template-columns: 1fr;
      }
      thead {
        font-size: 0.75rem;
      }
      tbody td {
        font-size: 0.75rem;
      }
    }
  </style>
</head>
<body>
  <div class="page">
    <h1>Acompanhamento dos Estudantes</h1>
    <p class="subtitle">
      Preencha seu nome, selecione a escola (e opcionalmente a turma),
      preencha as trÃªs Ãºltimas colunas e use o campo de observaÃ§Ã£o quando necessÃ¡rio.
      Depois clique em <strong>"Gerar XLSX e enviar"</strong>.
    </p>

    <div class="filters">
      <div class="field">
        <label for="nomeResponsavel">Seu nome</label>
        <input
          type="text"
          id="nomeResponsavel"
          placeholder="Digite seu nome completo"
        />
      </div>

      <div class="field">
        <label for="escolaInput">Escola</label>
        <input
          id="escolaInput"
          list="listaEscolas"
          placeholder="Digite ou selecione"
        />
        <datalist id="listaEscolas"></datalist>
      </div>

      <div class="field">
        <label for="turmaSelect">Turma</label>
        <select id="turmaSelect" disabled>
          <option value="">Selecione uma escola primeiro</option>
        </select>
      </div>
    </div>

    <div class="table-wrapper">
      <table id="tabelaAlunos">
        <thead></thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="actions-bar">
      <button id="btnGerar" class="btn-primary">
        <span class="icon">ðŸ’¾</span>
        <span>Gerar XLSX e enviar</span>
      </button>
      <span id="statusMsg" class="status muted">
        O arquivo original Ã© lido de <strong>dados.csv</strong> (mesma pasta deste HTML).
      </span>
    </div>
  </div>

  <script>
    // Nomes das colunas que podem estar no CSV mas serÃ£o redesenhadas
    const HEADER_RESULTADO = "RESULTADO (SEM 15 a 19/12)";
    const HEADER_ACOMPANHADO = "ESTUDANTE ACOMPANHADO?";
    const HEADER_ACOES = "AÃ‡Ã•ES";

    // OpÃ§Ãµes fixas
    const RESULTADO_OPCOES = ["Aprovado", "Reprovado"];
    const ACOMPANHADO_OPCOES = ["Sim", "NÃ£o"];
    const ACOES_OPCOES = [
      "Acompanhamento Professor(a)",
      "Aluno Monitor",
      "Atendimento Especializado",
      "Atendimento Individualizado",
      "Plano de Estudos",
      "PMA",
      "Rede de ProteÃ§Ã£o",
      "Sareh",
      "Saiu da Lista",
      "Outro"
    ];

    let csvRows = [];
    let csvFields = [];
    let displayFields = []; // campos exibidos na tabela (sem as 3 colunas antigas)
    let ESCOLA_FIELD = null;
    let TURMA_FIELD = null;

    const tbody = document.querySelector("#tabelaAlunos tbody");
    const thead = document.querySelector("#tabelaAlunos thead");
    const escolaInput = document.getElementById("escolaInput");
    const listaEscolas = document.getElementById("listaEscolas");
    const turmaSelect = document.getElementById("turmaSelect");
    const btnGerar = document.getElementById("btnGerar");
    const statusMsg = document.getElementById("statusMsg");
    const nomeResponsavel = document.getElementById("nomeResponsavel");

    function setStatus(msg, type = "muted") {
      statusMsg.textContent = msg;
      statusMsg.className = "status " + type;
    }

    // Carregar CSV
    fetch("dados.csv")
      .then((r) => {
        if (!r.ok) throw new Error("NÃ£o foi possÃ­vel carregar dados.csv");
        return r.text();
      })
      .then((csvText) => {
        Papa.parse(csvText, {
          header: true,
          skipEmptyLines: true,
          complete: (results) => {
            csvRows = results.data;
            csvFields = results.meta.fields || [];

            if (!csvRows.length) {
              setStatus("dados.csv nÃ£o possui linhas de dados.", "error");
              return;
            }

            // Remove das colunas exibidas as versÃµes antigas das 3 Ãºltimas
            displayFields = csvFields.filter((f) => {
              const ft = f.trim();
              return (
                ft !== HEADER_RESULTADO &&
                ft !== HEADER_ACOMPANHADO &&
                ft !== HEADER_ACOES
              );
            });

            const fieldsForDetection = displayFields.length
              ? displayFields
              : csvFields;

            ESCOLA_FIELD =
              fieldsForDetection.find((f) =>
                f.toLowerCase().includes("escola")
              ) || fieldsForDetection[0];

            TURMA_FIELD =
              fieldsForDetection.find((f) =>
                f.toLowerCase().includes("turma")
              ) ||
              fieldsForDetection.find((f) =>
                f.toLowerCase().includes("seria")
              ) ||
              fieldsForDetection[1];

            montarCabecalho();
            popularEscolas();
            setStatus(
              "Selecione uma escola para visualizar os dados.",
              "muted"
            );
          }
        });
      })
      .catch((err) => {
        console.error(err);
        setStatus(
          "Erro ao carregar dados.csv. Verifique se o arquivo estÃ¡ na mesma pasta.",
          "error"
        );
      });

    function montarCabecalho() {
      thead.innerHTML = "";
      const tr = document.createElement("tr");

      // CabeÃ§alhos exibidos (sem as 3 colunas antigas)
      displayFields.forEach((field) => {
        const th = document.createElement("th");
        th.textContent = field;
        tr.appendChild(th);
      });

      // Novas colunas interativas com layout melhorado
      // 1) RESULTADO + (SEM 15 a 19/12) embaixo
      const thRes = document.createElement("th");
      thRes.classList.add("col-resultado");
      thRes.innerHTML =
        'RESULTADO<br><small>(SEM 15 a 19/12)</small>';
      tr.appendChild(thRes);

      // 2) ESTUDANTE + ACOMPANHADO? embaixo
      const thAcomp = document.createElement("th");
      thAcomp.classList.add("col-acompanhado");
      thAcomp.innerHTML =
        "ESTUDANTE<br>ACOMPANHADO?";
      tr.appendChild(thAcomp);

      // 3) AÃ‡Ã•ES (coluna mais larga)
      const thAcoes = document.createElement("th");
      thAcoes.classList.add("col-acoes");
      thAcoes.textContent = "AÃ‡Ã•ES";
      tr.appendChild(thAcoes);

      // 4) OBSERVAÃ‡ÃƒO (coluna mais larga)
      const thObs = document.createElement("th");
      thObs.classList.add("col-obs");
      thObs.textContent = "OBSERVAÃ‡ÃƒO";
      tr.appendChild(thObs);

      thead.appendChild(tr);
    }

    function popularEscolas() {
      const escolasSet = new Set(
        csvRows
          .map((row) => row[ESCOLA_FIELD])
          .filter((v) => v && v.trim() !== "")
      );
      listaEscolas.innerHTML = "";
      escolasSet.forEach((esc) => {
        const opt = document.createElement("option");
        opt.value = esc;
        listaEscolas.appendChild(opt);
      });
    }

    function atualizarTurmas(escola) {
      if (!escola) {
        turmaSelect.innerHTML =
          '<option value="">Selecione uma escola primeiro</option>';
        turmaSelect.disabled = true;
        return;
      }

      const turmasSet = new Set(
        csvRows
          .filter((row) => row[ESCOLA_FIELD] === escola)
          .map((row) => row[TURMA_FIELD])
          .filter((v) => v && v.trim() !== "")
      );

      turmaSelect.innerHTML =
        '<option value="">Todas as turmas</option>';
      turmasSet.forEach((turma) => {
        const opt = document.createElement("option");
        opt.value = opt.textContent = turma;
        turmaSelect.appendChild(opt);
      });
      turmaSelect.disabled = false;
    }

    function filtrarDados() {
      const escola = escolaInput.value.trim();
      const turma = turmaSelect.value;

      if (!escola) {
        tbody.innerHTML = "";
        setStatus(
          "Selecione uma escola para visualizar os dados.",
          "muted"
        );
        return [];
      }

      let filtrado = csvRows.filter(
        (row) => row[ESCOLA_FIELD] === escola
      );

      if (turma) {
        filtrado = filtrado.filter(
          (row) => row[TURMA_FIELD] === turma
        );
      }

      desenharTabela(filtrado);

      if (!filtrado.length) {
        setStatus(
          "Nenhum registro encontrado para o filtro selecionado.",
          "muted"
        );
      } else {
        setStatus(
          `${filtrado.length} registro(s) carregado(s). Preencha as colunas finais e clique em "Gerar XLSX e enviar".`,
          "ok"
        );
      }

      return filtrado;
    }

    function desenharTabela(rows) {
      tbody.innerHTML = "";
      rows.forEach((row, idx) => {
        const tr = document.createElement("tr");
        tr.dataset.rowIndex = idx.toString();

        // Colunas originais (sem as antigas de resultado/acompanhado/aÃ§Ãµes)
        displayFields.forEach((field) => {
          const td = document.createElement("td");
          td.textContent = row[field] ?? "";
          tr.appendChild(td);
        });

        // RESULTADO
        const tdResultado = document.createElement("td");
        tdResultado.classList.add("col-resultado");
        const selRes = document.createElement("select");
        selRes.className = "resultado-select";
        const optVazioR = document.createElement("option");
        optVazioR.value = "";
        optVazioR.textContent = "";
        selRes.appendChild(optVazioR);
        RESULTADO_OPCOES.forEach((op) => {
          const o = document.createElement("option");
          o.value = o.textContent = op;
          selRes.appendChild(o);
        });
        tdResultado.appendChild(selRes);
        tr.appendChild(tdResultado);

        // ESTUDANTE ACOMPANHADO
        const tdAcomp = document.createElement("td");
        tdAcomp.classList.add("col-acompanhado");
        const selAcomp = document.createElement("select");
        selAcomp.className = "acomp-select";
        const optVazioA = document.createElement("option");
        optVazioA.value = "";
        optVazioA.textContent = "";
        selAcomp.appendChild(optVazioA);
        ACOMPANHADO_OPCOES.forEach((op) => {
          const o = document.createElement("option");
          o.value = o.textContent = op;
          selAcomp.appendChild(o);
        });
        tdAcomp.appendChild(selAcomp);
        tr.appendChild(tdAcomp);

        // AÃ‡Ã•ES
        const tdAcoes = document.createElement("td");
        tdAcoes.classList.add("col-acoes");
        const selAcoes = document.createElement("select");
        selAcoes.className = "acoes-select";
        const optVazioAc = document.createElement("option");
        optVazioAc.value = "";
        optVazioAc.textContent = "";
        selAcoes.appendChild(optVazioAc);
        ACOES_OPCOES.forEach((op) => {
          const o = document.createElement("option");
          o.value = o.textContent = op;
          selAcoes.appendChild(o);
        });
        tdAcoes.appendChild(selAcoes);
        tr.appendChild(tdAcoes);

        // OBSERVAÃ‡ÃƒO (campo livre)
        const tdObs = document.createElement("td");
        tdObs.classList.add("col-obs");
        const inputObs = document.createElement("input");
        inputObs.type = "text";
        inputObs.className = "obs-input";
        inputObs.placeholder = "ObservaÃ§Ãµesâ€¦";
        tdObs.appendChild(inputObs);
        tr.appendChild(tdObs);

        tbody.appendChild(tr);
      });
    }

    escolaInput.addEventListener("change", () => {
      const escola = escolaInput.value.trim();
      atualizarTurmas(escola);
      filtrarDados();
    });

    escolaInput.addEventListener("blur", () => {
      const escola = escolaInput.value.trim();
      atualizarTurmas(escola);
      filtrarDados();
    });

    turmaSelect.addEventListener("change", filtrarDados);

function validarAntesDeEnviar() {
  // limpa erro visual
  nomeResponsavel.classList.remove("campo-erro");

  const nome = nomeResponsavel.value.trim();

  // 1) ERRO: nome vazio â†’ sai imediatamente
  if (!nome) {
    setStatus("Por favor, preencha seu nome antes de continuar.", "error");
    nomeResponsavel.classList.add("campo-erro");
    nomeResponsavel.focus();
    return false; // <-- interrompe aqui
  }

  // 2) ValidaÃ§Ã£o das linhas
  const linhas = Array.from(tbody.querySelectorAll("tr"));
  linhas.forEach((tr) => tr.classList.remove("erro-validacao"));

  if (!linhas.length) {
    setStatus(
      "Nenhum registro carregado. Selecione uma escola e, se desejar, uma turma.",
      "error"
    );
    return false;
  }

  // 3) ERRO: â€œSimâ€ sem AÃ§Ã£o
  let problema = false;
  linhas.forEach((tr) => {
    const acomp = tr.querySelector(".acomp-select")?.value || "";
    const acao  = tr.querySelector(".acoes-select")?.value || "";

    if (acomp === "Sim" && !acao) {
      tr.classList.add("erro-validacao");
      problema = true;
    }
  });

  if (problema) {
    setStatus(
      "HÃ¡ linhas marcadas em vermelho: quando 'Estudante acompanhado?' for 'Sim', a seleÃ§Ã£o de AÃ‡ÃƒO Ã© obrigatÃ³ria.",
      "error"
    );
    return false;
  }

  // Tudo certo
  return true;
}

    function montarMatrizDadosParaExportar() {
      const linhas = Array.from(tbody.querySelectorAll("tr"));
      const header = [
        ...displayFields,
        HEADER_RESULTADO,
        HEADER_ACOMPANHADO,
        HEADER_ACOES,
        "OBSERVAÃ‡ÃƒO"
      ];

      const matriz = [header];

      linhas.forEach((tr) => {
        const tds = tr.querySelectorAll("td");
        const base = [];
        for (let i = 0; i < displayFields.length; i++) {
          base.push((tds[i]?.textContent || "").trim());
        }

        const resultado =
          tr.querySelector(".resultado-select")?.value || "";
        const acompanhado =
          tr.querySelector(".acomp-select")?.value || "";
        const acao =
          tr.querySelector(".acoes-select")?.value || "";
        const obs =
          tr.querySelector(".obs-input")?.value || "";

        matriz.push([
          ...base,
          resultado,
          acompanhado,
          acao,
          obs
        ]);
      });

      return matriz;
    }

    function matrizParaCSV(matriz) {
      return matriz
        .map((linha) =>
          linha
            .map((valor) => {
              if (valor == null) return "";
              const s = String(valor);
              if (/[;",\n]/.test(s)) {
                return '"' + s.replace(/"/g, '""') + '"';
              }
              return s;
            })
            .join(";")
        )
        .join("\r\n");
    }

    function baixarXLSX(matriz, nomeArquivo) {
      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.aoa_to_sheet(matriz);
      XLSX.utils.book_append_sheet(wb, ws, "Acompanhamento");
      const wbout = XLSX.write(wb, {
        bookType: "xlsx",
        type: "array"
      });

      const blob = new Blob([wbout], {
        type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
      });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = nomeArquivo;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);

      // retorna base64 para enviar por e-mail
      const u8 = new Uint8Array(wbout);
      let bin = "";
      u8.forEach((b) => (bin += String.fromCharCode(b)));
      return btoa(bin);
    }

    function slug(str) {
      return (str || "")
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "")
        .replace(/[^a-zA-Z0-9]+/g, "_")
        .replace(/^_+|_+$/g, "")
        .toLowerCase()
        .slice(0, 40);
    }

    btnGerar.addEventListener("click", async () => {
      if (!validarAntesDeEnviar()) return;

      const escola = escolaInput.value.trim();
      if (!escola) {
        setStatus(
          "Selecione uma escola antes de gerar o arquivo.",
          "error"
        );
        return;
      }

      const matriz = montarMatrizDadosParaExportar();
      const nome = nomeResponsavel.value.trim();
      const turma = turmaSelect.value || "todas_turmas";

      const baseNome = `acompanhamento_${slug(escola)}_${slug(
        turma
      )}_${slug(nome) || "responsavel"}`;
      const csvNome = `${baseNome}.csv`;
      const xlsxNome = `${baseNome}.xlsx`;

      try {
        setStatus(
          "Gerando arquivos e enviando para o servidor...",
          "muted"
        );

        const csvString = matrizParaCSV(matriz);
        const xlsxBase64 = baixarXLSX(matriz, xlsxNome);

        const resp = await fetch(
          "/.netlify/functions/enviar-email",
          {
            method: "POST",
            headers: {
              "Content-Type": "application/json"
            },
            body: JSON.stringify({
              csv: csvString,
              xlsx: xlsxBase64,
              escola,
              turma:
                turma === "todas_turmas" ? "" : turma,
              nome,
              filename: csvNome,
              xlsxFilename: xlsxNome
            })
          }
        );

        if (!resp.ok) {
          const text = await resp.text();
          console.error("Resposta do servidor:", text);
          setStatus(
            "Arquivo baixado. Houve um problema ao enviar para o servidor.",
            "error"
          );
        } else {
          setStatus(
            "Arquivo XLSX baixado e enviado para o e-mail configurado com sucesso.",
            "ok"
          );
        }
      } catch (err) {
        console.error(err);
        setStatus(
          "Arquivo baixado. Houve um problema ao enviar para o servidor.",
          "error"
        );
      }
    });
  </script>
</body>
</html>
